#!/usr/bin/env ruby
# coding: utf-8

require "thor"
require "csv"
require "uri"
require 'ostruct'

class RedirectConfig < Thor

  desc "csv_to_apache <CSVFILE",
       <<-EOT
Creates RewriteRules for Apache web server from given CSVFILE as complementary to apache_to_csv.
       EOT
  def csv_to_apache
    line_no = 0

    CSV($stdin, row_sep: "\r\n", headers: true).each do |in_row|
      line_no += 1

      pattern = in_row['Pattern']
      destination = in_row['Destination']
      condition = in_row['Condition']
      r = in_row['R']
      l = boolean in_row['L']
      nc = boolean in_row['NC']
      ne = boolean in_row['NE']
      re = boolean in_row['RE']
      qsa = boolean in_row['QSA']
      qsd = boolean in_row['QSD']

      f = []
      f << "r=#{r}" if r
      f << "ne" if ne
      f << "nc" if nc
      f << "l" if l
      f << "qsa" if qsa
      f << "qsd" if qsd
      flags = "[#{f.join(',')}]" unless f.empty?

      pattern = "^#{Regexp.escape(pattern)}$" unless re

      puts "RewriteCond\t#{condition}" if condition
      puts "RewriteRule\t#{pattern} #{destination} #{flags}"
    end
  end

  no_commands do
    def boolean(str)
      if /^\s*[fFnN]/.match(str)
        false
      else
        true
      end
    end
  end
end

RedirectConfig.start(ARGV)
